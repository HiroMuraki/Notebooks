# Gitea 部署指南（Docker）

## 1. 环境

| 环境类型  | 值              |
| --------- | --------------- |
| 操作系统  | Ubuntu 24.04    |
| 架构      | x64             |
| 局域网 IP | 192.168.100.101 |

## 2. 部署

### 2.1. 创建 docker-compose.yml

```yml
name: gitea

services:
    # 1. Gitea 代码托管平台主体
    server:
        image: gitea/gitea:latest
        restart: always
        environment:
            # 配置 UID 与 GID，避免权限问题
            - USER_UID=1000
            - USER_GID=1000
            # 配置 HTTP 代理，用于加速从 Github 拉取仓库
            - HTTP_PROXY=192.168.100.101:7890
            - HTTPS_PROXY=192.168.100.101:7890
            # 配置 NO_PROXY 防止内部通信走代理
            - NO_PROXY=localhost,127.0.0.1,.local,::1,gitea,db
            # 时区信息
            - TZ=Asia/Shanghai
            # 数据库设置（小规模可用 SQLite）
            - GITEA__database__DB_TYPE=sqlite3
            - GITEA__database__PATH=/data/gitea/gitea.db
        volumes:
            - ./gitea_data:/data
        ports:
            # Web 界面端口
            - "3000:3000" 
            # Git SSH 端口
            - "2222:22" 

    # 2. act_runner CI 执行器 Runner
    runner:
        image: gitea/act_runner:latest
        restart: always
        depends_on:
            - server
        volumes:
            - ./runner_data:/data
            # 关键：让 Runner 能调用宿主机的 Docker 来构建镜像
            - /var/run/docker.sock:/var/run/docker.sock
        environment:
            - GITEA_INSTANCE_URL=http://server:3000
            # 配置文件路径
            - CONFIG_FILE=/data/config.yaml
            # 下面这个 Token 需要先启动 server，稍后处理
            - GITEA_RUNNER_REGISTRATION_TOKEN=
```

### 2.2. 准备配置

执行以下命令创建备挂载的目录

```bash
mkdir gitea_data
mkdir runner_data
```

> 不要让 docker 自动创建，否则目录权限默认归属 root 用户

- Gitea 配置

在启动时配置即可，后续也可通过编辑宿主机被挂载的 `./gitea_data/gitea/conf/app.ini` 文件进行配置。

- Runner 配置

执行以下命令生成 `Runner` 的配置文件模板 `runner_data/config.yaml`

```bash
docker run --entrypoint="" --rm gitea/act_runner:latest act_runner generate-config > runner_data/config.yaml
```

配置如下字段：

| 字段                     | 值                   | 说明                                                                                |
| ------------------------ | -------------------- | ----------------------------------------------------------------------------------- |
| `runner`.`github_mirror` | <http://server:3000> | 以 gitea 自身作为镜像，加速 CI                                                      |
| `container`.`network`    | gitea_default        | 设定 runner 创建的 worker 使用的网络，填 compose 中使用的网络（默认为name_default） |

### 2.3. 启动与配置 Gitea

执行以下命令启动容器编排

```bash
docker compose up --build
```

启动完成后打开 [http://localhost:3000](http://localhost:3000)，进入 Gitea 初始配置页面，按需调整配置（通常保持默认即可），并注册管理员账户。

其中的**基础 URL**尤其需要更改，需将其修改为宿主机 IP，如 `192.168.100.101`。

### 2.4. 配置 ACT Runner

打开 `设置` -> `工作流` -> `运行器`，点击 `创建新运行器`，复制 `Registration Token`，将该 Token 填入到 `docker-compose.yml` 的 `GITEA_RUNNER_REGISTRATION_TOKEN`，如下

```yml
runner:
    environment:
        - GITEA_RUNNER_REGISTRATION_TOKEN=$你的Token
```

### 2.5. 预拉取 Action

使用**迁移外部仓库**功能，将以下 Action 仓库作为**镜像仓库**导入。

| 组织名  | 仓库名称          | URL                                           |
| ------- | ----------------- | --------------------------------------------- |
| actions | checkout          | <https://github.com/actions/checkout>         |
| docker  | metadata-action   | <https://github.com/docker/metadata-action>   |
| docker  | login-action      | <https://github.com/docker/login-action>      |
| docker  | build-push-action | <https://github.com/docker/build-push-action> |

> 预拉取是为了让 Gitea Action 直接使用本地镜像，能显著提高 CI 效率

## 3. CI 测试

基于 [test_repo](./test) 创建一个简单的 CI 测试项目，但先不同步到 Gitea。

### 3.1. 配置变量

`设置` -> `工作流` -> `变量`

| 变量            | 值                   |
| --------------- | -------------------- |
| DOCKER_REGISTRY | 192.168.100.101:3000 |

> 此处的值填宿主机局域网 IP 是因为 runner 里使用的是宿主机的 Docker。

### 3.2. 配置密钥

（1）创建令牌

`设置` -> `应用`

令牌名称：ci-worker

| 权限       | 选项 |
| ---------- | ---- |
| repository | 读写 |

（2）将令牌添加为密钥

`设置` -> `工作流` -> `密钥`

| 变量           | Value       |
| -------------- | ----------- |
| PACKAGES_TOKEN | $生成的密钥 |

### 3.3. 配置 Docker

将 `http://192.168.100.101:3000` 添加到宿主机 Docker 的 `insecure-registries` 条目中

```json
{
    // ...其他配置...
    "insecure-registries": [
        "192.168.100.101:3000"
    ],
}
```

### 3.4. 推送触发 CI

在 `Gitea` 创建一个空仓库，并将 `test_repo` 代码推送到 `Gitea` 后即可触发 CI。
